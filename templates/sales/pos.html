{% extends "base.html" %}
{% load static %}

{% block title %}POS - Point of Sale{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ðŸ›’ Point of Sale</h2>

    <!-- Customer Selection -->
    <div class="card mb-4">
        <div class="card-header">
            <strong>Customer</strong>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Customer Type</label>
                <select id="customer-type" class="form-select">
                    <option value="regular" selected>Regular Customer</option>
                    <option value="irregular">IR Customer</option>
                </select>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Search by Name</label>
                    <input id="customer-name" class="form-control" list="customer-names" placeholder="Start typing name...">
                    <datalist id="customer-names">
                        {% for customer in customers %}
                        <option value="{{ customer.customer_name }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Search by Mobile</label>
                    <input id="customer-phone" class="form-control" list="customer-phones" placeholder="9XXXXXXXXX">
                    <datalist id="customer-phones">
                        {% for customer in customers %}
                        <option value="{{ customer.phone_number }}"></option>
                        {% if customer.secondary_phone_number %}
                        <option value="{{ customer.secondary_phone_number }}"></option>
                        {% endif %}
                        {% endfor %}
                    </datalist>
                </div>
            </div>

            <div id="irregular-customer-fields" class="row g-3 mt-2 d-none">
                <div class="col-md-4">
                    <label class="form-label">IR Customer Name</label>
                    <input id="ir-customer-name" class="form-control" placeholder="Enter name">
                </div>
                <div class="col-md-4">
                    <label class="form-label">IR Phone (optional)</label>
                    <input id="ir-customer-phone" class="form-control" placeholder="Phone number">
                </div>
                <div class="col-md-4">
                    <label class="form-label">IR Address (optional)</label>
                    <input id="ir-customer-address" class="form-control" placeholder="Address">
                </div>
            </div>

            <div class="mt-3">
                <div class="row">
                    <div class="col-md-4"><strong>Name:</strong> <span id="cust-name">â€”</span></div>
                    <div class="col-md-4"><strong>Phone:</strong> <span id="cust-phone">â€”</span></div>
                    <div class="col-md-4"><strong>Credit:</strong> <span id="cust-credit">â€”</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="card">
        <div class="card-header">
            <strong>Products</strong>
        </div>
        <div class="card-body">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Barcode</label>
                    <div class="mb-2">
                        <select id="barcode-mode" class="form-select">
                            <option value="scan" selected>Scan Barcode</option>
                            <option value="manual">Enter Barcode Number</option>
                        </select>
                    </div>
                    <input id="barcode-input" class="form-control" placeholder="Scan barcode...">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Product Name</label>
                    <input id="barcode-product-input" class="form-control" list="barcode-product-list" placeholder="Choose product...">
                    <datalist id="barcode-product-list">
                        {% for product in products %}
                        <option value="{{ product.product_name }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered" id="pos-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 45%;">Product Name</th>
                            <th style="width: 15%;">Price</th>
                            <th style="width: 15%;">Quantity</th>
                            <th style="width: 15%;">Line Total</th>
                            <th style="width: 10%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="pos-body">
                        <tr>
                            <td>
                                <input class="form-control product-input" list="product-list" placeholder="Type product name...">
                                <datalist id="product-list">
                                    {% for product in products %}
                                    <option value="{{ product.product_name }}"></option>
                                    {% endfor %}
                                </datalist>
                            </td>
                            <td><input class="form-control price-input" readonly></td>
                            <td><input type="number" class="form-control qty-input" min="1" value="1"></td>
                            <td><input class="form-control total-input" readonly></td>
                            <td><button class="btn btn-sm btn-danger remove-row">Ã—</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-start align-items-center mt-3">
                <button id="add-row" class="btn btn-outline-secondary">+</button>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <label class="form-label">Payment Type</label>
                    <select id="payment-type" class="form-select">
                        <option value="full" selected>Full Payment</option>
                        <option value="partial">Partial Payment</option>
                        <option value="credit">Credit</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Payment Method</label>
                    <select id="payment-method" class="form-select">
                        <option value="cash" selected>Cash</option>
                        <option value="card">QR</option>
                        <option value="credit">Credit</option>
                    </select>
                    <div id="card-qr-wrapper" class="mt-3 d-none">
                        <div class="small text-muted mb-2">Scan to pay</div>
                        <img id="card-qr" src="{% static 'qr.png' %}" alt="QR payment" class="img-fluid" style="max-width: 220px;">
                    </div>
                </div>
                <div class="col-md-6 mt-3 mt-md-0">
                    <label class="form-label">Paid Amount</label>
                    <input id="paid-amount" type="number" class="form-control" value="0">
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4">
                <h5 class="mb-0">Grand Total: <span id="grand-total">Rs. 0.00</span></h5>
                <button id="confirm-sale" class="btn btn-success">Confirm Payment</button>
            </div>
        </div>
    </div>
</div>

<script>
const customers = [
    {% for customer in customers %}
    {
        id: {{ customer.id }},
        name: "{{ customer.customer_name|escapejs }}",
        phone: "{{ customer.phone_number|escapejs }}",
        secondary_phone: "{{ customer.secondary_phone_number|default:''|escapejs }}",
        credit: "{{ customer.current_credit }}"
    },
    {% endfor %}
];

const products = [
    {% for product in products %}
    {
        id: {{ product.id }},
        name: "{{ product.product_name|escapejs }}",
        barcode: "{{ product.barcode|default:''|escapejs }}",
        price: {{ product.selling_price }},
    },
    {% endfor %}
];

const nameInput = document.getElementById('customer-name');
const phoneInput = document.getElementById('customer-phone');
const customerType = document.getElementById('customer-type');
const irregularFields = document.getElementById('irregular-customer-fields');
const irNameInput = document.getElementById('ir-customer-name');
const irPhoneInput = document.getElementById('ir-customer-phone');
const irAddressInput = document.getElementById('ir-customer-address');

function setCustomerDetails(customer) {
    if (!customer) {
        document.getElementById('cust-name').textContent = 'â€”';
        document.getElementById('cust-phone').textContent = 'â€”';
        document.getElementById('cust-credit').textContent = 'â€”';
        return;
    }
    document.getElementById('cust-name').textContent = customer.name;
    document.getElementById('cust-phone').textContent = customer.phone;
    document.getElementById('cust-credit').textContent = `Rs. ${customer.credit}`;
}

if (customerType) {
    customerType.addEventListener('change', () => {
        const isIrregular = customerType.value === 'irregular';
        irregularFields.classList.toggle('d-none', !isIrregular);
        nameInput.disabled = isIrregular;
        phoneInput.disabled = isIrregular;
        if (isIrregular) {
            nameInput.value = '';
            phoneInput.value = '';
            setCustomerDetails(null);
        } else {
            irNameInput.value = '';
            irPhoneInput.value = '';
            irAddressInput.value = '';
        }
    });
}

nameInput.addEventListener('input', () => {
    const customer = customers.find(c => c.name.toLowerCase() === nameInput.value.toLowerCase());
    if (customer) {
        phoneInput.value = customer.phone;
        setCustomerDetails(customer);
    }
});

phoneInput.addEventListener('input', () => {
    const customer = customers.find(
        c => c.phone === phoneInput.value || c.secondary_phone === phoneInput.value
    );
    if (customer) {
        nameInput.value = customer.name;
        setCustomerDetails(customer);
    }
});

function recalcRow(row) {
    const nameField = row.querySelector('.product-input');
    const priceField = row.querySelector('.price-input');
    const qtyField = row.querySelector('.qty-input');
    const totalField = row.querySelector('.total-input');

    const product = products.find(p => p.name.toLowerCase() === nameField.value.toLowerCase());
    if (product) {
        priceField.value = product.price;
    }

    const price = parseFloat(priceField.value || '0');
    const qty = Math.max(1, parseInt(qtyField.value || '1', 10));
    totalField.value = (price * qty).toFixed(2);
}

function recalcGrandTotal() {
    let total = 0;
    document.querySelectorAll('.total-input').forEach(input => {
        total += parseFloat(input.value || '0');
    });
    document.getElementById('grand-total').textContent = `Rs. ${total.toFixed(2)}`;
    const paidInput = document.getElementById('paid-amount');
    const paymentType = document.getElementById('payment-type')?.value;
    if (paidInput && !paidInput.dataset.touched && paymentType === 'full') {
        paidInput.value = total.toFixed(2);
    }
}

function addProductToPos(product) {
    const rows = Array.from(document.querySelectorAll('#pos-body tr'));
    let targetRow = rows.find(row => !row.querySelector('.product-input').value.trim());
    if (!targetRow) {
        const tbody = document.getElementById('pos-body');
        const newRow = tbody.children[0].cloneNode(true);
        newRow.querySelectorAll('input').forEach(input => input.value = '');
        newRow.querySelector('.qty-input').value = 1;
        attachRowEvents(newRow);
        tbody.appendChild(newRow);
        targetRow = newRow;
    }

    targetRow.querySelector('.product-input').value = product.name;
    targetRow.querySelector('.price-input').value = product.price;
    targetRow.querySelector('.qty-input').value = 1;
    recalcRow(targetRow);
    recalcGrandTotal();
}

function attachRowEvents(row) {
    row.querySelector('.product-input').addEventListener('input', () => {
        recalcRow(row);
        recalcGrandTotal();
    });
    row.querySelector('.qty-input').addEventListener('input', () => {
        recalcRow(row);
        recalcGrandTotal();
    });
    row.querySelector('.remove-row').addEventListener('click', (e) => {
        e.preventDefault();
        if (document.querySelectorAll('#pos-body tr').length > 1) {
            row.remove();
            recalcGrandTotal();
        }
    });
}

document.querySelectorAll('#pos-body tr').forEach(attachRowEvents);

const barcodeInput = document.getElementById('barcode-input');
const barcodeMode = document.getElementById('barcode-mode');
if (barcodeMode && barcodeInput) {
    barcodeMode.addEventListener('change', () => {
        if (barcodeMode.value === 'manual') {
            barcodeInput.placeholder = 'Enter barcode number...';
        } else {
            barcodeInput.placeholder = 'Scan barcode...';
        }
        barcodeInput.focus();
    });
}
if (barcodeInput) {
    barcodeInput.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') {
            return;
        }
        e.preventDefault();
        const barcodeValue = barcodeInput.value.trim();
        if (!barcodeValue) {
            return;
        }
        const product = products.find(p => p.barcode && p.barcode.toLowerCase() === barcodeValue.toLowerCase());
        if (product) {
            addProductToPos(product);
            barcodeInput.value = '';
        } else {
            alert('No product found for that barcode.');
        }
    });
}

const barcodeProductInput = document.getElementById('barcode-product-input');
if (barcodeProductInput) {
    const addByName = () => {
        const nameValue = barcodeProductInput.value.trim();
        if (!nameValue) {
            return;
        }
        const product = products.find(p => p.name.toLowerCase() === nameValue.toLowerCase());
        if (product) {
            addProductToPos(product);
            barcodeProductInput.value = '';
        } else {
            alert('No product found with that name.');
        }
    };
    barcodeProductInput.addEventListener('change', addByName);
    barcodeProductInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addByName();
        }
    });
}

document.getElementById('add-row').addEventListener('click', (e) => {
    e.preventDefault();
    const tbody = document.getElementById('pos-body');
    const newRow = tbody.children[0].cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => input.value = '');
    newRow.querySelector('.qty-input').value = 1;
    attachRowEvents(newRow);
    tbody.appendChild(newRow);
});

document.getElementById('paid-amount').addEventListener('input', (e) => {
    e.target.dataset.touched = 'true';
});

function syncPaymentControls() {
    const paymentType = document.getElementById('payment-type').value;
    const methodSelect = document.getElementById('payment-method');
    const paidInput = document.getElementById('paid-amount');
    const qrWrapper = document.getElementById('card-qr-wrapper');

    if (paymentType === 'credit') {
        methodSelect.value = 'credit';
        methodSelect.disabled = true;
        paidInput.value = 0;
        paidInput.disabled = true;
        paidInput.dataset.touched = 'true';
        qrWrapper?.classList.add('d-none');
        return;
    }

    methodSelect.disabled = false;
    paidInput.disabled = false;

    if (paymentType === 'full') {
        paidInput.dataset.touched = '';
        recalcGrandTotal();
    }
}

document.getElementById('payment-type').addEventListener('change', () => {
    syncPaymentControls();
});

document.getElementById('payment-method').addEventListener('change', (e) => {
    const qrWrapper = document.getElementById('card-qr-wrapper');
    if (!qrWrapper) {
        return;
    }
    if (e.target.value === 'card') {
        qrWrapper.classList.remove('d-none');
    } else {
        qrWrapper.classList.add('d-none');
    }
});

document.getElementById('confirm-sale').addEventListener('click', async (e) => {
    e.preventDefault();
    const rows = Array.from(document.querySelectorAll('#pos-body tr'));
    const items = [];

    rows.forEach(row => {
        const name = row.querySelector('.product-input').value.trim();
        const qty = parseInt(row.querySelector('.qty-input').value || '1', 10);
        const product = products.find(p => p.name.toLowerCase() === name.toLowerCase());
        if (product && qty > 0) {
            items.push({
                product_id: product.id,
                quantity: qty,
                price: product.price,
                line_total: product.price * qty,
            });
        }
    });

    if (!items.length) {
        alert('Add at least one product.');
        return;
    }

    const subtotal = items.reduce((sum, i) => sum + i.line_total, 0);
    const tax = 0;
    const total = subtotal + tax;
    const paymentType = document.getElementById('payment-type').value;
    const paymentMethod = document.getElementById('payment-method').value;
    const paidAmount = paymentType === 'credit'
        ? 0
        : parseFloat(document.getElementById('paid-amount').value || '0');

    const isIrregular = customerType && customerType.value === 'irregular';
    const payload = {
        customer_type: isIrregular ? 'irregular' : 'regular',
        customer_name: !isIrregular && document.getElementById('cust-name').textContent !== 'â€”'
            ? document.getElementById('cust-name').textContent
            : null,
        customer_phone: !isIrregular && document.getElementById('cust-phone').textContent !== 'â€”'
            ? document.getElementById('cust-phone').textContent
            : null,
        ir_customer_name: isIrregular ? (irNameInput.value || null) : null,
        ir_customer_phone: isIrregular ? (irPhoneInput.value || '') : null,
        ir_customer_address: isIrregular ? (irAddressInput.value || '') : null,
        items,
        subtotal,
        tax,
        total,
        paid_amount: paidAmount,
        payment_method: paymentType === 'credit' ? 'credit' : paymentMethod,
    };

    const response = await fetch('/sales/api/create-sale/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    });

    const result = await response.json();
    if (result.success) {
        alert(`Sale saved. Receipt: ${result.receipt_number}`);
        window.location.href = `/sales/receipt/${result.sale_number}/`;
    } else {
        alert(result.error || 'Failed to save sale');
    }
});

syncPaymentControls();

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
