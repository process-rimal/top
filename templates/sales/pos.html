{% extends "base.html" %}

{% block title %}POS - Point of Sale{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ðŸ›’ Point of Sale</h2>

    <!-- Customer Selection -->
    <div class="card mb-4">
        <div class="card-header">
            <strong>Customer</strong>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Search by Name</label>
                    <input id="customer-name" class="form-control" list="customer-names" placeholder="Start typing name...">
                    <datalist id="customer-names">
                        {% for customer in customers %}
                        <option value="{{ customer.customer_name }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Search by Mobile</label>
                    <input id="customer-phone" class="form-control" list="customer-phones" placeholder="9XXXXXXXXX">
                    <datalist id="customer-phones">
                        {% for customer in customers %}
                        <option value="{{ customer.phone_number }}"></option>
                        {% if customer.secondary_phone_number %}
                        <option value="{{ customer.secondary_phone_number }}"></option>
                        {% endif %}
                        {% endfor %}
                    </datalist>
                </div>
            </div>

            <div class="mt-3">
                <div class="row">
                    <div class="col-md-4"><strong>Name:</strong> <span id="cust-name">â€”</span></div>
                    <div class="col-md-4"><strong>Phone:</strong> <span id="cust-phone">â€”</span></div>
                    <div class="col-md-4"><strong>Credit:</strong> <span id="cust-credit">â€”</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="card">
        <div class="card-header">
            <strong>Products</strong>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="pos-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 45%;">Product Name</th>
                            <th style="width: 15%;">Price</th>
                            <th style="width: 15%;">Quantity</th>
                            <th style="width: 15%;">Line Total</th>
                            <th style="width: 10%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="pos-body">
                        <tr>
                            <td>
                                <input class="form-control product-input" list="product-list" placeholder="Type product name...">
                                <datalist id="product-list">
                                    {% for product in products %}
                                    <option value="{{ product.product_name }}"></option>
                                    {% endfor %}
                                </datalist>
                            </td>
                            <td><input class="form-control price-input" readonly></td>
                            <td><input type="number" class="form-control qty-input" min="1" value="1"></td>
                            <td><input class="form-control total-input" readonly></td>
                            <td><button class="btn btn-sm btn-danger remove-row">Ã—</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-start align-items-center mt-3">
                <button id="add-row" class="btn btn-outline-secondary">+</button>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <label class="form-label">Payment Method</label>
                    <select id="payment-method" class="form-select">
                        <option value="cash" selected>Cash</option>
                        <option value="card">Card</option>
                        <option value="credit">Credit</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Paid Amount</label>
                    <input id="paid-amount" type="number" class="form-control" value="0">
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4">
                <h5 class="mb-0">Grand Total: <span id="grand-total">Rs. 0.00</span></h5>
                <button id="confirm-sale" class="btn btn-success">Confirm Payment</button>
            </div>
        </div>
    </div>
</div>

<script>
const customers = [
    {% for customer in customers %}
    {
        id: {{ customer.id }},
        name: "{{ customer.customer_name|escapejs }}",
        phone: "{{ customer.phone_number|escapejs }}",
        secondary_phone: "{{ customer.secondary_phone_number|default:''|escapejs }}",
        credit: "{{ customer.current_credit }}"
    },
    {% endfor %}
];

const products = [
    {% for product in products %}
    {
        id: {{ product.id }},
        name: "{{ product.product_name|escapejs }}",
        price: {{ product.selling_price }},
    },
    {% endfor %}
];

const nameInput = document.getElementById('customer-name');
const phoneInput = document.getElementById('customer-phone');

function setCustomerDetails(customer) {
    if (!customer) {
        document.getElementById('cust-name').textContent = 'â€”';
        document.getElementById('cust-phone').textContent = 'â€”';
        document.getElementById('cust-credit').textContent = 'â€”';
        return;
    }
    document.getElementById('cust-name').textContent = customer.name;
    document.getElementById('cust-phone').textContent = customer.phone;
    document.getElementById('cust-credit').textContent = `Rs. ${customer.credit}`;
}

nameInput.addEventListener('input', () => {
    const customer = customers.find(c => c.name.toLowerCase() === nameInput.value.toLowerCase());
    if (customer) {
        phoneInput.value = customer.phone;
        setCustomerDetails(customer);
    }
});

phoneInput.addEventListener('input', () => {
    const customer = customers.find(
        c => c.phone === phoneInput.value || c.secondary_phone === phoneInput.value
    );
    if (customer) {
        nameInput.value = customer.name;
        setCustomerDetails(customer);
    }
});

function recalcRow(row) {
    const nameField = row.querySelector('.product-input');
    const priceField = row.querySelector('.price-input');
    const qtyField = row.querySelector('.qty-input');
    const totalField = row.querySelector('.total-input');

    const product = products.find(p => p.name.toLowerCase() === nameField.value.toLowerCase());
    if (product) {
        priceField.value = product.price;
    }

    const price = parseFloat(priceField.value || '0');
    const qty = Math.max(1, parseInt(qtyField.value || '1', 10));
    totalField.value = (price * qty).toFixed(2);
}

function recalcGrandTotal() {
    let total = 0;
    document.querySelectorAll('.total-input').forEach(input => {
        total += parseFloat(input.value || '0');
    });
    document.getElementById('grand-total').textContent = `Rs. ${total.toFixed(2)}`;
    const paidInput = document.getElementById('paid-amount');
    if (paidInput && !paidInput.dataset.touched) {
        paidInput.value = total.toFixed(2);
    }
}

function attachRowEvents(row) {
    row.querySelector('.product-input').addEventListener('input', () => {
        recalcRow(row);
        recalcGrandTotal();
    });
    row.querySelector('.qty-input').addEventListener('input', () => {
        recalcRow(row);
        recalcGrandTotal();
    });
    row.querySelector('.remove-row').addEventListener('click', (e) => {
        e.preventDefault();
        if (document.querySelectorAll('#pos-body tr').length > 1) {
            row.remove();
            recalcGrandTotal();
        }
    });
}

document.querySelectorAll('#pos-body tr').forEach(attachRowEvents);

document.getElementById('add-row').addEventListener('click', (e) => {
    e.preventDefault();
    const tbody = document.getElementById('pos-body');
    const newRow = tbody.children[0].cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => input.value = '');
    newRow.querySelector('.qty-input').value = 1;
    attachRowEvents(newRow);
    tbody.appendChild(newRow);
});

document.getElementById('paid-amount').addEventListener('input', (e) => {
    e.target.dataset.touched = 'true';
});

document.getElementById('confirm-sale').addEventListener('click', async (e) => {
    e.preventDefault();
    const rows = Array.from(document.querySelectorAll('#pos-body tr'));
    const items = [];

    rows.forEach(row => {
        const name = row.querySelector('.product-input').value.trim();
        const qty = parseInt(row.querySelector('.qty-input').value || '1', 10);
        const product = products.find(p => p.name.toLowerCase() === name.toLowerCase());
        if (product && qty > 0) {
            items.push({
                product_id: product.id,
                quantity: qty,
                price: product.price,
                line_total: product.price * qty,
            });
        }
    });

    if (!items.length) {
        alert('Add at least one product.');
        return;
    }

    const subtotal = items.reduce((sum, i) => sum + i.line_total, 0);
    const tax = 0;
    const total = subtotal + tax;
    const paymentMethod = document.getElementById('payment-method').value;
    const paidAmount = paymentMethod === 'credit' ? 0 : parseFloat(document.getElementById('paid-amount').value || '0');

    const payload = {
        customer_name: document.getElementById('cust-name').textContent !== 'â€”' ? document.getElementById('cust-name').textContent : null,
        customer_phone: document.getElementById('cust-phone').textContent !== 'â€”' ? document.getElementById('cust-phone').textContent : null,
        items,
        subtotal,
        tax,
        total,
        paid_amount: paidAmount,
        payment_method: paymentMethod,
    };

    const response = await fetch('/sales/api/create-sale/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    });

    const result = await response.json();
    if (result.success) {
        alert(`Sale saved. Receipt: ${result.receipt_number}`);
        window.location.reload();
    } else {
        alert(result.error || 'Failed to save sale');
    }
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
